---
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import { Image } from "astro:assets";
import {
  products,
  getProductBySlug,
  getRelatedProducts,
  formatPrice,
  type Product,
} from "@/data/products";

// Generate static paths for all products
export function getStaticPaths() {
  return products.map((product) => ({
    params: { slug: product.slug },
    props: { product },
  }));
}

interface Props {
  product: Product;
}

const { product } = Astro.props;
const relatedProducts = getRelatedProducts(product.slug, 4);

// Store-specific navigation
const storeNavLinks = [
  { href: "/", label: "Inicio" },
  { href: "/tienda", label: "Tienda" },
  {
    href: "/programacion",
    label: "AFRO IN Tour",
    children: [
      { href: "/programacion", label: "Programaci√≥n" },
      { href: "/programacion/santa-marta", label: "Santa Marta" },
      { href: "/programacion/palenque", label: "Palenque" },
      { href: "/artistas", label: "Artistas" },
    ],
  },
  { href: "/#contacto", label: "Contacto" },
];
const storeCta = { href: "/#unirse", label: "√önete" };
---

<Layout title={`${product.name} | Tienda AFRO IN`}>
  <Header navLinks={storeNavLinks} ctaLink={storeCta} />
  <main class="product-page">
    <div class="container">
      <!-- Breadcrumb -->
      <nav class="breadcrumb">
        <a href="/tienda">‚Üê Volver a la Tienda</a>
      </nav>

      <!-- Product Content -->
      <div class="product-grid">
        <!-- Gallery -->
        <div class="product-gallery">
          <div class="main-image">
            <Image
              src={product.images[0]}
              alt={product.name}
              class="gallery-img"
              loading="eager"
            />
            {
              product.badge && (
                <span class={`product-badge ${product.badge.toLowerCase()}`}>
                  {product.badge}
                </span>
              )
            }
          </div>
          {
            product.images.length > 1 && (
              <div class="thumbnail-strip">
                {product.images.map((img, i) => (
                  <button
                    class={`thumb ${i === 0 ? "active" : ""}`}
                    data-index={i}
                  >
                    <Image src={img} alt={`${product.name} ${i + 1}`} />
                  </button>
                ))}
              </div>
            )
          }
        </div>

        <!-- Details -->
        <div class="product-details">
          <div class="product-info-header">
            <span class="category-badge">{product.category}</span>
            <span class="sku-badge">SKU: {product.sku}</span>
          </div>
          <h1 class="product-name">{product.name}</h1>

          <div class="product-prices">
            <span class="price-cop">{formatPrice(product.price)}</span>
            <span class="price-usd">~${product.priceUSD} USD</span>
          </div>

          <p class="product-description">{product.description}</p>

          <!-- Product Actions: Size/Color Selection + Add to Cart -->
          <div
            class="product-actions"
            id="product-actions"
            data-product-id={product.id}
            data-product-slug={product.slug}
            data-product-sku={product.sku}
            data-product-name={product.name}
            data-product-price={product.price}
            data-product-image={product.images[0].src}
            data-product-instock={product.inStock}
            data-product-sizes={product.sizes?.join(",") || ""}
            data-product-colors={product.colors?.join(",") || ""}
          >
            {
              product.sizes && product.sizes.length > 0 && (
                <div class="variant-selector">
                  <label>Talla:</label>
                  <div class="variant-options size-options">
                    {product.sizes.map((size) => (
                      <button
                        class="variant-btn"
                        data-size={size}
                        type="button"
                      >
                        {size}
                      </button>
                    ))}
                  </div>
                  <span
                    class="size-error"
                    id="size-error"
                    style="display: none;"
                  >
                    ‚ö†Ô∏è Por favor selecciona una talla
                  </span>
                </div>
              )
            }

            {
              product.colors && product.colors.length > 0 && (
                <div class="variant-selector">
                  <label>Color:</label>
                  <div class="variant-options color-options">
                    {product.colors.map((color) => (
                      <button
                        class="variant-btn"
                        data-color={color}
                        type="button"
                      >
                        {color}
                      </button>
                    ))}
                  </div>
                </div>
              )
            }

            <button
              class="btn btn-primary btn-add-cart"
              id="add-to-cart-btn"
              disabled={!product.inStock}
            >
              Agregar al Carrito
            </button>

            {!product.inStock && <p class="stock-status">‚ùå Agotado</p>}
          </div>

          <div class="product-meta">
            <p>üì¶ Env√≠o a toda Colombia</p>
            <p>üí¨ Pedido confirmado por WhatsApp</p>
            <p>üîÑ 30 d√≠as de devoluci√≥n</p>
          </div>
        </div>
      </div>

      <!-- Related Products -->
      {
        relatedProducts.length > 0 && (
          <section class="related-products">
            <h2>Tambi√©n te puede gustar</h2>
            <div class="related-grid">
              {relatedProducts.map((related) => (
                <a href={`/tienda/${related.slug}`} class="related-card">
                  <div class="related-image">
                    <Image src={related.images[0]} alt={related.name} />
                  </div>
                  <h3>{related.name}</h3>
                  <span class="related-price">
                    {formatPrice(related.price)}
                  </span>
                </a>
              ))}
            </div>
          </section>
        )
      }
    </div>
  </main>
  <Footer />
</Layout>

<style>
  .product-page {
    padding: var(--space-xl) 0;
    padding-top: 120px; /* Account for fixed header */
    min-height: 100vh;
    background: var(--color-cream);
  }

  .breadcrumb {
    margin-bottom: var(--space-lg);
  }

  .breadcrumb a {
    color: var(--color-text-light);
    font-size: 0.9rem;
    transition: color var(--transition-fast);
  }

  .breadcrumb a:hover {
    color: var(--color-primary);
  }

  .product-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-2xl);
    margin-bottom: var(--space-2xl);
  }

  /* Gallery */
  .product-gallery {
    position: sticky;
    top: 100px;
  }

  .main-image {
    position: relative;
    background: var(--color-white);
    border-radius: var(--radius-lg);
    overflow: hidden;
    aspect-ratio: 1;
  }

  .gallery-img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    padding: var(--space-lg);
  }

  .product-badge {
    position: absolute;
    top: var(--space-md);
    right: var(--space-md);
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  .product-badge.popular {
    background: var(--color-primary);
    color: var(--color-white);
  }

  .product-badge.nuevo {
    background: var(--color-success);
    color: var(--color-white);
  }

  .thumbnail-strip {
    display: flex;
    gap: var(--space-sm);
    margin-top: var(--space-md);
  }

  .thumb {
    width: 80px;
    height: 80px;
    border: 2px solid transparent;
    border-radius: var(--radius-md);
    overflow: hidden;
    cursor: pointer;
    background: var(--color-white);
    transition: border-color var(--transition-fast);
  }

  .thumb.active,
  .thumb:hover {
    border-color: var(--color-primary);
  }

  .thumb img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  /* Details */
  .product-details {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  .product-info-header {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }

  .category-badge {
    display: inline-block;
    padding: var(--space-xs) var(--space-sm);
    background: rgba(227, 28, 37, 0.1);
    color: var(--color-primary);
    border-radius: var(--radius-full);
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  .sku-badge {
    font-size: 0.8rem;
    color: var(--color-text-light);
    font-weight: 500;
  }

  .product-name {
    font-size: clamp(1.75rem, 4vw, 2.5rem);
    color: var(--color-secondary);
    margin: 0;
  }

  .product-prices {
    display: flex;
    align-items: baseline;
    gap: var(--space-sm);
  }

  .price-cop {
    font-family: var(--font-heading);
    font-size: 2rem;
    font-weight: 700;
    color: var(--color-primary);
  }

  .price-usd {
    font-size: 1rem;
    color: var(--color-text-light);
  }

  .product-description {
    font-size: 1.1rem;
    color: var(--color-text);
    line-height: 1.7;
  }

  /* Variant Selectors */
  .variant-selector {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .variant-selector label {
    font-weight: 600;
    color: var(--color-text);
  }

  .variant-options {
    display: flex;
    gap: var(--space-xs);
    flex-wrap: wrap;
  }

  .variant-btn {
    padding: var(--space-sm) var(--space-md);
    border: 2px solid var(--color-cream-dark);
    border-radius: var(--radius-md);
    background: var(--color-white);
    cursor: pointer;
    font-weight: 500;
    transition: all var(--transition-fast);
  }

  .variant-btn:hover,
  .variant-btn.selected {
    border-color: var(--color-primary);
    background: rgba(227, 28, 37, 0.05);
  }

  /* Add to Cart */
  .btn-add-cart {
    font-size: 1.1rem;
    padding: var(--space-md) var(--space-lg);
    margin-top: var(--space-md);
    transition: all 0.2s ease;
  }

  .btn-add-cart.added {
    background: #25d366 !important;
    border-color: #25d366 !important;
  }

  .btn-add-cart:disabled {
    background: #ccc;
    cursor: not-allowed;
  }

  .size-error {
    display: block;
    color: var(--color-primary);
    font-size: 0.85rem;
    margin-top: 0.5rem;
  }

  .stock-status {
    font-size: 0.9rem;
    color: var(--color-text);
  }

  .product-meta {
    margin-top: var(--space-md);
    padding: var(--space-md);
    background: var(--color-white);
    border-radius: var(--radius-md);
  }

  .product-meta p {
    margin: var(--space-xs) 0;
    font-size: 0.9rem;
    color: var(--color-text-light);
  }

  /* Related Products */
  .related-products {
    border-top: 1px solid var(--color-cream-dark);
    padding-top: var(--space-xl);
  }

  .related-products h2 {
    font-size: 1.5rem;
    color: var(--color-secondary);
    margin-bottom: var(--space-lg);
  }

  .related-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-md);
  }

  .related-card {
    text-align: center;
    transition: transform var(--transition-fast);
  }

  .related-card:hover {
    transform: translateY(-4px);
  }

  .related-image {
    background: var(--color-white);
    border-radius: var(--radius-md);
    aspect-ratio: 1;
    margin-bottom: var(--space-sm);
    overflow: hidden;
  }

  .related-image img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    padding: var(--space-sm);
  }

  .related-card h3 {
    font-size: 0.95rem;
    color: var(--color-secondary);
    margin-bottom: var(--space-xs);
  }

  .related-price {
    font-weight: 700;
    color: var(--color-primary);
  }

  /* Responsive */
  @media (max-width: 968px) {
    .product-grid {
      grid-template-columns: 1fr;
      gap: var(--space-xl);
    }

    .product-gallery {
      position: static;
    }

    .related-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 600px) {
    .related-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-sm);
    }

    .thumbnail-strip {
      overflow-x: auto;
      padding-bottom: var(--space-sm);
    }
  }
</style>

<script>
  import { addToCart, showToast, openCart } from "@/lib/cart";

  document.addEventListener("astro:page-load", () => {
    // Thumbnail gallery click
    document.querySelectorAll(".thumb").forEach((thumb) => {
      thumb.addEventListener("click", () => {
        document
          .querySelectorAll(".thumb")
          .forEach((t) => t.classList.remove("active"));
        thumb.classList.add("active");
      });
    });

    // Variant selection
    let selectedSize: string | null = null;
    let selectedColor: string | null = null;

    document.querySelectorAll(".size-options .variant-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        document
          .querySelectorAll(".size-options .variant-btn")
          .forEach((b) => b.classList.remove("selected"));
        btn.classList.add("selected");
        selectedSize = btn.getAttribute("data-size");
        const sizeError = document.getElementById("size-error");
        if (sizeError) sizeError.style.display = "none";
      });
    });

    document.querySelectorAll(".color-options .variant-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        document
          .querySelectorAll(".color-options .variant-btn")
          .forEach((b) => b.classList.remove("selected"));
        btn.classList.add("selected");
        selectedColor = btn.getAttribute("data-color");
      });
    });

    // Add to cart
    const addBtn = document.getElementById("add-to-cart-btn");
    const productEl = document.getElementById("product-actions");

    addBtn?.addEventListener("click", () => {
      if (!productEl) return;

      const hasSizes =
        productEl.dataset.productSizes &&
        productEl.dataset.productSizes.length > 0;

      // Validate size if product has sizes
      if (hasSizes && !selectedSize) {
        const sizeError = document.getElementById("size-error");
        if (sizeError) sizeError.style.display = "block";
        return;
      }

      // Build cart item
      const slug = productEl.dataset.productSlug || "";
      const sku = productEl.dataset.productSku || "";
      let id = slug;
      if (selectedSize) id += `-${selectedSize}`;
      if (selectedColor) id += `-${selectedColor}`;

      const item = {
        id,
        sku,
        name: productEl.dataset.productName || "",
        price: parseInt(productEl.dataset.productPrice || "0"),
        image: productEl.dataset.productImage || "",
        size: selectedSize || undefined,
        color: selectedColor || undefined,
      };

      addToCart(item);
      showToast(`${item.name} agregado al carrito`);

      // Open cart after short delay
      setTimeout(() => openCart(), 300);

      // Success feedback
      if (addBtn) {
        const originalText = addBtn.textContent;
        addBtn.textContent = "‚úì ¬°Agregado!";
        addBtn.classList.add("added");
        setTimeout(() => {
          addBtn.textContent = originalText;
          addBtn.classList.remove("added");
        }, 2000);
      }
    });
  });
</script>
