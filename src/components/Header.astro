---
import { Image } from "astro:assets";
import afroinLogo from "../assets/img/logos/afroin.png";
import CartWidget from "./CartWidget.astro";
import LanguagePicker from "./LanguagePicker.astro";
import { getLangFromUrl, useTranslations } from "../i18n/utils";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const langPrefix = lang === "es" ? "" : `/${lang}`;

interface NavLink {
  href: string;
  label: string;
  children?: NavLink[];
}

interface Props {
  currentPage?: string;
  navLinks?: NavLink[];
  ctaLink?: { href: string; label: string };
}

// Default navigation for home page
const defaultNavLinks: NavLink[] = [
  { href: `${langPrefix}/#sobre`, label: t("nav.about") },
  { href: `${langPrefix}/#galeria`, label: t("nav.gallery") },
  { href: `${langPrefix}/tienda`, label: t("nav.store") },
  {
    href: `${langPrefix}/programacion`,
    label: t("nav.tour"),
    children: [
      { href: `${langPrefix}/programacion`, label: t("nav.program") },
      { href: `${langPrefix}/programacion/santa-marta`, label: "Santa Marta" },
      { href: `${langPrefix}/programacion/palenque`, label: "Palenque" },
      { href: `${langPrefix}/artistas`, label: t("nav.artists") },
    ],
  },
  { href: `${langPrefix}/#aliados`, label: t("nav.allies") },
  { href: `${langPrefix}/#contacto`, label: t("nav.contact") },
];

const defaultCta = { href: `${langPrefix}/#unirse`, label: t("nav.join") };

const {
  currentPage = "home",
  navLinks = defaultNavLinks,
  ctaLink = defaultCta,
} = Astro.props;

// Get current URL path for active state
const currentPath = Astro.url.pathname;

// Helper to check if link is active
function isActive(href: string): boolean {
  // Normalize paths by removing trailing slashes
  const normalizedHref = href.replace(/\/$/, "") || "/";
  const normalizedPath = currentPath.replace(/\/$/, "") || "/";

  // Skip anchor links - they don't need active state on home
  if (href.includes("/#")) return false;

  // Home page exact match only for "/" link
  if (href === "/" || href === `/${lang}`)
    return normalizedPath === "/" || normalizedPath === `/${lang}`;

  // Exact match for specific pages
  return normalizedPath === normalizedHref;
}
---

<header
  class="header fixed top-0 left-0 right-0 z-1000 backdrop-blur-md transition-all duration-300"
>
  <nav class="nav container flex items-center justify-between h-20">
    <a href={`${langPrefix}/`} class="logo flex items-center shrink-0">
      <Image
        src={afroinLogo}
        alt="AFRO IN"
        class="logo-img h-8 sm:h-12 w-auto"
        loading="eager"
        fetchpriority="high"
        decoding="sync"
        width={160}
        height={75}
        quality={80}
      />
    </a>

    <ul
      class="nav-links flex items-center gap-8 list-none md:flex-1 md:justify-end"
    >
      {
        navLinks.map((link) => (
          <li class={link.children ? "has-dropdown" : ""}>
            <div class="nav-item-wrapper">
              <a
                href={link.href}
                class={`nav-link font-medium relative transition-colors duration-150 py-3 ${isActive(link.href) ? "active" : ""}`}
                aria-current={isActive(link.href) ? "page" : undefined}
              >
                <span>{link.label}</span>
                {link.children && (
                  <svg
                    class="dropdown-icon ml-1 inline-block"
                    xmlns="http://www.w3.org/2000/svg"
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="m6 9 6 6 6-6" />
                  </svg>
                )}
              </a>
              {link.children && (
                <button
                  class="mobile-dropdown-toggle bg-transparent border-none p-3 cursor-pointer md:hidden min-w-[44px] min-h-[44px] flex items-center justify-center"
                  aria-label="Expandir submenú"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="m6 9 6 6 6-6" />
                  </svg>
                </button>
              )}
            </div>
            {link.children && (
              <ul class="dropdown-menu">
                {link.children.map((child) => (
                  <li>
                    <a
                      href={child.href}
                      class={`dropdown-link ${isActive(child.href) ? "active" : ""}`}
                    >
                      {child.label}
                    </a>
                  </li>
                ))}
              </ul>
            )}
          </li>
        ))
      }
    </ul>
    <div class="nav-actions flex items-center gap-2 sm:gap-4 md:ml-8 shrink-0">
      <LanguagePicker />
      <div class="cart-nav-item">
        <CartWidget />
      </div>

      <a
        href={ctaLink.href}
        class="btn btn-primary nav-cta py-1.5 px-3 sm:py-2 sm:px-6 flex items-center justify-center text-xs sm:text-base font-bold"
        >{ctaLink.label}</a
      >

      <button
        class="menu-toggle w-8 h-8 sm:w-10 sm:h-10 relative md:hidden flex items-center justify-center"
        aria-label="Abrir menú"
        aria-expanded="false"
      >
        <span class="hamburger"></span>
      </button>
    </div>
  </nav>
</header>

<style>
  .header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    background: rgba(from var(--color-cream) r g b / 0.95);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    transition: all var(--transition-normal);
  }

  .header.scrolled {
    box-shadow: var(--shadow-sm);
  }

  .nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 80px;
    flex-wrap: nowrap;
    gap: var(--space-xs);
  }

  .logo {
    display: flex;
    align-items: center;
  }

  .logo-img {
    height: 50px;
    width: auto;
    object-fit: contain;
  }

  .nav-links {
    display: flex;
    align-items: center;
    gap: var(--space-lg);
    list-style: none;
  }

  .nav-link {
    display: flex;
    align-items: center;
    font-weight: 500;
    color: var(--color-text);
    transition: color var(--transition-fast);
    position: relative;
    padding: 0.5rem 0;
  }

  .nav-link::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;
    width: 0;
    height: 2px;
    background: var(--color-primary);
    transition: width var(--transition-normal);
  }

  .nav-link:hover {
    color: var(--color-primary);
  }

  .nav-link.active {
    color: var(--color-primary);
    font-weight: 600;
  }

  .nav-link.active::after {
    width: 100%;
  }

  .nav-link:hover::after {
    width: 100%;
  }

  .nav-item-wrapper {
    display: flex;
    align-items: center;
    gap: 0;
  }

  .dropdown-icon {
    transition: transform var(--transition-normal);
  }

  .has-dropdown:hover .dropdown-icon {
    transform: rotate(180deg);
  }

  .mobile-dropdown-toggle {
    display: none;
  }

  .has-dropdown {
    position: relative;
  }

  .dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    transform: translateY(10px);
    min-width: 200px;
    background: var(--color-white);
    box-shadow: var(--shadow-md);
    border-radius: var(--radius-md);
    padding: var(--space-sm) 0;
    list-style: none;
    opacity: 0;
    visibility: hidden;
    transition: all var(--transition-normal);
    z-index: 1001;
    border: 1px solid rgba(0, 0, 0, 0.05);
  }

  .has-dropdown:hover .dropdown-menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .dropdown-link {
    display: block;
    padding: var(--space-sm) var(--space-lg);
    color: var(--color-text);
    text-decoration: none;
    transition: all var(--transition-fast);
    font-size: 0.95rem;
    font-weight: 500;
  }

  .dropdown-link:hover {
    background: rgba(from var(--color-primary) r g b / 0.05);
    color: var(--color-primary);
    padding-left: calc(var(--space-lg) + 4px);
  }

  .dropdown-link.active {
    color: var(--color-primary);
    background: rgba(from var(--color-primary) r g b / 0.05);
  }

  .nav-cta {
    padding: var(--space-sm) var(--space-lg) !important;
  }

  .menu-toggle {
    display: none;
    width: 40px;
    height: 40px;
    position: relative;
  }

  .hamburger,
  .hamburger::before,
  .hamburger::after {
    position: absolute;
    width: 24px;
    height: 2px;
    background: var(--color-secondary);
    border-radius: 2px;
    transition: all var(--transition-normal);
  }

  .hamburger {
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  .hamburger::before,
  .hamburger::after {
    content: "";
    left: 0;
  }

  .hamburger::before {
    top: -8px;
  }
  .hamburger::after {
    bottom: -8px;
  }

  /* Mobile Styles */
  @media (max-width: 768px) {
    .nav {
      padding-left: var(--space-sm);
      padding-right: var(--space-sm);
      gap: var(--space-xs);
    }

    .logo-img {
      height: 32px !important;
    }

    .menu-toggle {
      display: block;
    }

    .nav-links {
      position: fixed;
      top: 80px;
      left: 0;
      right: 0;
      height: calc(100vh - 80px);
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      padding-top: var(--space-xl);
      gap: var(--space-lg);
      background: rgba(250, 250, 250, 0.95);
      backdrop-filter: blur(10px);
      transform: translateX(100%);
      transition: transform var(--transition-normal);
      z-index: 999;
      overflow-y: auto;
      display: flex; /* Ensure it's flex when open */
    }

    .nav-links.open {
      transform: translateX(0);
    }

    .md\:hidden {
      display: block !important;
    }

    .nav-link {
      font-size: 1.25rem;
    }

    .has-dropdown {
      width: 100%;
      text-align: center;
    }

    .nav-item-wrapper {
      justify-content: center;
      width: 100%;
    }

    .dropdown-menu {
      position: static;
      opacity: 1;
      visibility: visible;
      transform: none;
      box-shadow: none;
      background: transparent;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      width: 100%;
      padding: 0;
      border: none;
    }

    .has-dropdown.mobile-open .dropdown-menu {
      max-height: 500px;
      padding: var(--space-sm) 0;
    }

    .mobile-dropdown-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text);
    }

    .nav-link .dropdown-icon {
      display: none;
    }

    .has-dropdown.mobile-open .mobile-dropdown-toggle {
      transform: rotate(180deg);
      color: var(--color-primary);
    }

    .dropdown-link {
      font-size: 1.1rem;
      padding: var(--space-xs) 0;
      opacity: 0.8;
      width: 100%;
    }

    .dropdown-link:hover {
      padding-left: 0;
    }

    .menu-toggle[aria-expanded="true"] .hamburger {
      background: transparent;
    }

    .menu-toggle[aria-expanded="true"] .hamburger::before {
      top: 0;
      transform: rotate(45deg);
    }

    .menu-toggle[aria-expanded="true"] .hamburger::after {
      bottom: 0;
      transform: rotate(-45deg);
    }

    .logo-img {
      max-width: 120px;
      height: auto;
    }
  }
</style>

<script>
  document.addEventListener("astro:page-load", () => {
    const menuToggle = document.querySelector(".menu-toggle");
    const navLinks = document.querySelector(".nav-links");
    const header = document.querySelector(".header");

    menuToggle?.addEventListener("click", () => {
      const isOpen = menuToggle.getAttribute("aria-expanded") === "true";
      menuToggle.setAttribute("aria-expanded", (!isOpen).toString());
      navLinks?.classList.toggle("open");
    });

    // Handle dropdown toggles on mobile
    document.querySelectorAll(".mobile-dropdown-toggle").forEach((toggle) => {
      toggle.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        const parent = toggle.closest(".has-dropdown");
        parent?.classList.toggle("mobile-open");
      });
    });

    // Close menu when clicking ANY link
    document.querySelectorAll(".nav-link, .dropdown-link").forEach((link) => {
      link.addEventListener("click", () => {
        if (window.innerWidth <= 768) {
          menuToggle?.setAttribute("aria-expanded", "false");
          navLinks?.classList.remove("open");
          document
            .querySelectorAll(".has-dropdown")
            .forEach((el) => el.classList.remove("mobile-open"));
        }
      });
    });

    // Header scroll effect
    const scrollHandler = () => {
      if (window.scrollY > 50) {
        header?.classList.add("scrolled");
      } else {
        header?.classList.remove("scrolled");
      }
    };

    // Apply immediately on page load
    scrollHandler();

    // Listen for future scrolls
    window.addEventListener("scroll", scrollHandler);
  });
</script>
