---
import { countries } from "../data/countries";

interface Props {
  currentCount?: number;
}

const { currentCount = 12847 } = Astro.props;

// PayPal Client ID from environment variables
const paypalClientId = import.meta.env.PUBLIC_PAYPAL_CLIENT_ID || "";
const isDev = import.meta.env.PUBLIC_ENV === "development";
---

<section class="registration section" id="unirse">
  <div class="container">
    <div class="registration-wrapper">
      <div
        class="registration-content animate-fade-in-up"
        style="animation-delay: 0.1s"
      >
        <span class="section-badge">√önete al Movimiento</span>
        <h2 class="section-title">
          S√© Parte del<br /><span class="title-highlight"
            >Mill√≥n de Corazones</span
          >
        </h2>

        <div class="counter-badge">
          <span class="counter-number" id="live-counter">...</span>
          <span class="counter-label">ya se han unido üíõ</span>
        </div>

        <p class="registration-description">
          Con solo <strong>$5 USD (20,000 COP)</strong> te conviertes en parte de
          nuestra comunidad y apoyas directamente el arte afro independiente.
        </p>

        <ul class="benefits-list">
          <li>‚úÖ Acceso a contenido exclusivo</li>
          <li>‚úÖ Noticias y eventos de AFRO IN</li>
          <li>‚úÖ Descuentos en la tienda</li>
          <li>‚úÖ Tu nombre en nuestra comunidad</li>
          <li>‚úÖ Certificado digital de apoyo</li>
        </ul>
      </div>

      <div class="registration-form-wrapper">
        <div class="form-card">
          <form class="registration-form" id="registrationForm">
            <!-- STEP 1: CONTACT INFO -->
            <div class="form-step active" id="step1">
              <div class="step-header">
                <span class="step-indicator">Paso 1 de 2</span>
                <h3>Tus Datos</h3>
              </div>

              <div class="form-group">
                <label for="name">Nombre Completo</label>
                <input
                  type="text"
                  id="name"
                  name="name"
                  placeholder="Tu nombre"
                  required
                />
              </div>

              <div class="form-group">
                <label for="email">Email</label>
                <input
                  type="email"
                  id="email"
                  name="email"
                  placeholder="tu@email.com"
                  required
                />
              </div>

              <div class="form-group">
                <label for="phone">Tel√©fono</label>
                <input
                  type="tel"
                  id="phone"
                  name="phone"
                  placeholder="+57 300 000 0000"
                />
              </div>

              <div class="form-group">
                <label for="country">Pa√≠s</label>
                <select id="country" name="country" autocomplete="off">
                  <option value="">Selecciona tu pa√≠s</option>
                  {
                    countries.map((c) => (
                      <option value={c.code}>
                        {c.emoji} {c.name}
                      </option>
                    ))
                  }
                </select>
              </div>

              <button
                type="button"
                class="btn btn-primary btn-block"
                id="btnNext"
              >
                Continuar con mi Aporte ‚Üí
              </button>
            </div>

            <!-- STEP 2: DONATION -->
            <div class="form-step" id="step2">
              <div class="step-header">
                <button type="button" class="btn-back" id="btnBack"
                  >‚Üê Volver</button
                >
                <span class="step-indicator">Paso 2 de 2</span>
                <h3>Tu Aporte</h3>
              </div>

              <div class="form-donation">
                <div class="donation-options">
                  <label class="donation-option">
                    <input type="radio" name="amount" value="5" checked />
                    <span class="option-content">
                      <span class="option-amount">$5 USD</span>
                      <span class="option-desc">~20,000 COP</span>
                    </span>
                  </label>
                  <label class="donation-option">
                    <input type="radio" name="amount" value="10" />
                    <span class="option-content">
                      <span class="option-amount">$10 USD</span>
                      <span class="option-desc">~40,000 COP</span>
                    </span>
                  </label>
                  <label class="donation-option">
                    <input type="radio" name="amount" value="25" />
                    <span class="option-content">
                      <span class="option-amount">$25 USD</span>
                      <span class="option-desc">~100,000 COP</span>
                    </span>
                  </label>
                  <label class="donation-option custom">
                    <input type="radio" name="amount" value="custom" />
                    <span class="option-content">
                      <span class="option-amount">Otro</span>
                      <input
                        type="number"
                        class="custom-amount"
                        placeholder="$"
                        min="1"
                        step="0.01"
                      />
                    </span>
                  </label>
                </div>
              </div>

              <!-- PayPal Donate Button Container -->
              <div id="paypal-donate-container"></div>

              <p class="form-note">üîí Pago seguro procesado por PayPal</p>
            </div>
          </form>
        </div>
      </div>
    </div>

    <style>
      .registration {
        background: var(--color-cream);
        position: relative;
        overflow: hidden;
      }

      .registration::before {
        content: "";
        position: absolute;
        top: 0;
        right: 0;
        width: 50%;
        height: 100%;
        background: var(--gradient-dark);
        border-radius: 100px 0 0 100px;
      }

      .registration-wrapper {
        position: relative;
        z-index: 1;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-xl);
        align-items: center;
      }

      /* Logo dimensions optimization */
      .section-badge {
        display: inline-block;
        padding: var(--space-xs) var(--space-md);
        background: rgba(227, 28, 37, 0.1);
        border-radius: var(--radius-full);
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--color-primary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: var(--space-md);
      }

      .section-title {
        font-size: clamp(2rem, 5vw, 3rem);
        color: var(--color-secondary);
        margin-bottom: var(--space-md);
      }

      .title-highlight {
        background: var(--gradient-gold);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .registration-description {
        font-size: 1.1rem;
        color: var(--color-text-light);
        margin-bottom: var(--space-lg);
      }

      .registration-description strong {
        color: var(--color-primary);
      }

      .benefits-list {
        list-style: none;
      }

      .benefits-list li {
        padding: var(--space-sm) 0;
        font-size: 1.05rem;
        color: var(--color-text);
      }

      .counter-badge {
        display: inline-flex;
        align-items: center;
        gap: var(--space-sm);
        background: var(--color-white);
        padding: var(--space-sm) var(--space-md);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-lg);
        box-shadow: var(--shadow-sm);
      }

      .counter-badge .counter-number {
        font-family: var(--font-heading);
        font-weight: 800;
        font-size: 1.5rem;
        color: var(--color-primary);
      }

      .counter-badge .counter-label {
        font-size: 0.9rem;
        color: var(--color-text);
        font-weight: 500;
      }

      .form-card {
        background: var(--color-white);
        border-radius: var(--radius-lg);
        padding: var(--space-lg);
        box-shadow: var(--shadow-lg);
        min-height: 400px;
        display: flex;
        align-items: center;
      }

      .registration-form {
        width: 100%;
      }

      .form-step {
        display: none;
        animation: fadeIn 0.3s ease-in-out;
      }

      .form-step.active {
        display: block;
      }

      .step-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--space-lg);
        border-bottom: 1px solid var(--color-cream-dark);
        padding-bottom: var(--space-sm);
      }

      .step-indicator {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--color-text-light);
      }

      .step-header h3 {
        font-size: 1.2rem;
        color: var(--color-secondary);
        margin: 0;
      }

      .form-group {
        margin-bottom: var(--space-md);
      }

      .btn-block {
        width: 100%;
        margin-top: var(--space-md);
      }

      .btn-back {
        background: none;
        border: none;
        color: var(--color-text-light);
        font-size: 0.9rem;
        cursor: pointer;
        padding: 0;
        text-decoration: underline;
      }

      .btn-back:hover {
        color: var(--color-primary);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .form-group label {
        display: block;
        font-weight: 500;
        margin-bottom: var(--space-xs);
        color: var(--color-text);
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: var(--space-sm) var(--space-md);
        border: 1px solid var(--color-cream-dark);
        border-radius: var(--radius-md);
        font-family: inherit;
        font-size: 1rem;
        transition: all var(--transition-fast);
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgba(227, 28, 37, 0.1);
      }

      .form-donation {
        margin: var(--space-lg) 0;
      }

      .donation-options {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--space-sm);
      }

      .donation-option input[type="radio"] {
        display: none;
      }

      .option-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: var(--space-md);
        border: 2px solid var(--color-cream-dark);
        border-radius: var(--radius-md);
        transition: all var(--transition-fast);
        height: 100%;
        min-height: 100px;
      }

      .donation-option input:checked + .option-content {
        border-color: var(--color-primary);
        background: rgba(227, 28, 37, 0.05);
      }

      .option-amount {
        font-family: var(--font-heading);
        font-weight: 700;
        font-size: 1.2rem;
        color: var(--color-secondary);
      }

      .option-desc {
        font-size: 0.8rem;
        color: var(--color-text-light);
      }

      .custom-amount {
        width: 80px;
        margin-top: var(--space-xs);
        padding: var(--space-xs);
        border: 1px solid var(--color-cream-dark);
        border-radius: var(--radius-sm);
        text-align: center;
      }

      #paypal-donate-container {
        width: 100%;
        min-height: 50px;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: var(--space-md);
        margin-bottom: var(--space-sm);
      }

      #paypal-donate-container img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
        transition:
          transform var(--transition-fast),
          opacity var(--transition-fast);
      }

      #paypal-donate-container img:hover {
        transform: scale(1.02);
        opacity: 0.9;
      }

      .form-note {
        text-align: center;
        font-size: 0.85rem;
        color: var(--color-text-light);
        margin-top: var(--space-md);
      }

      @media (max-width: 968px) {
        .registration::before {
          display: none;
        }
        .registration-wrapper {
          grid-template-columns: 1fr;
        }
        .registration-content {
          text-align: center;
        }
        .benefits-list {
          display: inline-block;
          text-align: left;
        }
      }

      @media (max-width: 600px) {
        .form-card {
          padding: var(--space-lg) var(--space-md);
        }
        .donation-options {
          grid-template-columns: 1fr;
        }
      }
    </style>

    <style is:global>
      /* Tom Select Custom Styling - Loaded in head but needs global styles here */
      .ts-wrapper.single .ts-control {
        padding: 0.8rem 1rem !important;
        border: 1px solid var(--color-cream-dark) !important;
        border-radius: var(--radius-md) !important;
        font-family: var(--font-body) !important;
        font-size: 1rem !important;
        background: var(--color-white) !important;
        box-shadow: none !important;
        min-height: 44px;
        display: flex;
        align-items: center;
      }
      .ts-wrapper.single.focus .ts-control {
        border-color: var(--color-primary) !important;
        box-shadow: 0 0 0 3px rgba(227, 28, 37, 0.1) !important;
      }
      .ts-dropdown {
        border-radius: var(--radius-md) !important;
        border: 1px solid var(--color-cream-dark) !important;
        box-shadow: var(--shadow-lg) !important;
        margin-top: 5px !important;
        z-index: 1000 !important;
      }
      .ts-dropdown .option.active {
        background-color: rgba(227, 28, 37, 0.1) !important;
        color: var(--color-primary) !important;
      }
    </style>

    <script>
      import { showToast } from "../lib/cart";

      declare global {
        interface Window {
          TomSelect: any;
          paypal: any;
        }
      }

      document.addEventListener("astro:page-load", () => {
        // --- Live Counter ---
        const liveCounter = document.getElementById("live-counter");
        async function updateCounter() {
          if (!liveCounter) return;
          try {
            const response = await fetch("/api/contador");
            if (response.ok) {
              const data = (await response.json()) as { total: number };
              liveCounter.textContent = data.total.toLocaleString();
            }
          } catch (error) {}
        }
        updateCounter();
        setInterval(updateCounter, 30000);

        // --- Form Controls ---
        const form = document.getElementById(
          "registrationForm"
        ) as HTMLFormElement;
        const step1 = document.getElementById("step1");
        const step2 = document.getElementById("step2");
        const btnNext = document.getElementById("btnNext");
        const btnBack = document.getElementById("btnBack");
        const countrySelect = document.getElementById(
          "country"
        ) as any as HTMLSelectElement;
        let tsInstance: any = null;
        let paypalButtonRendered = false;

        // --- Lazy TomSelect ---
        const loadTomSelect = async () => {
          if (window.TomSelect || tsInstance) return;

          // Load CSS and JS dynamically
          if (!document.getElementById("tom-select-css")) {
            const link = document.createElement("link");
            link.id = "tom-select-css";
            link.rel = "stylesheet";
            link.href =
              "https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css";
            document.head.appendChild(link);
          }

          if (!window.TomSelect) {
            await new Promise((resolve) => {
              const script = document.createElement("script");
              script.src =
                "https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js";
              script.onload = resolve;
              document.body.appendChild(script);
            });
          }

          if (countrySelect && window.TomSelect && !tsInstance) {
            tsInstance = new window.TomSelect(countrySelect, {
              create: false,
              sortField: { field: "text", direction: "asc" },
              render: {
                no_results: () =>
                  '<div class="no-results">Pa√≠s no encontrado...</div>',
              },
            });
            tsInstance.setValue("CO");
            fetch("https://ipapi.co/json/")
              .then((r) => r.json())
              .then((d: any) => {
                if (d.country_code && tsInstance)
                  tsInstance.setValue(d.country_code);
              })
              .catch(() => {});
          }
        };

        const initLazy = () => {
          loadTomSelect();
          countrySelect?.removeEventListener("focus", initLazy);
        };
        countrySelect?.addEventListener("focus", initLazy);

        const observer = new IntersectionObserver(
          (entries) => {
            if (entries[0].isIntersecting) {
              loadTomSelect();
              observer.disconnect();
            }
          },
          { rootMargin: "200px" }
        );
        const section = document.getElementById("unirse");
        if (section) observer.observe(section);

        // --- Load PayPal JavaScript SDK ---
        const loadPayPalSDK = async (): Promise<void> => {
          if (window.paypal) return;

          return new Promise((resolve, reject) => {
            const clientId = document.body.getAttribute(
              "data-paypal-client-id"
            );
            if (!clientId) {
              reject(new Error("PayPal Client ID not configured"));
              return;
            }

            const script = document.createElement("script");
            // Use JavaScript SDK with client-id for Smart Payment Buttons
            // enable-funding=card enables the "Pay with Card" option (Guest Checkout)
            script.src = `https://www.paypal.com/sdk/js?client-id=${clientId}&currency=USD&intent=capture&enable-funding=card`;
            script.onload = () => resolve();
            script.onerror = () =>
              reject(new Error("Failed to load PayPal SDK"));
            document.body.appendChild(script);
          });
        };

        // --- Render PayPal Smart Payment Buttons ---
        const renderPayPalButton = async () => {
          if (paypalButtonRendered) return;

          await loadPayPalSDK();

          const container = document.getElementById("paypal-donate-container");
          if (!container || !window.paypal) return;

          // Get form data
          const nameInput = document.getElementById("name") as HTMLInputElement;
          const emailInput = document.getElementById(
            "email"
          ) as HTMLInputElement;
          const phoneInput = document.getElementById(
            "phone"
          ) as HTMLInputElement;
          const countryValue = tsInstance
            ? tsInstance.getValue()
            : countrySelect.value;

          // Get selected amount
          const getSelectedAmount = (): string => {
            const selectedAmountEl = form.querySelector(
              'input[name="amount"]:checked'
            ) as HTMLInputElement;
            let amount = selectedAmountEl?.value || "5";

            if (amount === "custom") {
              const customInputEl = document.querySelector(
                ".custom-amount"
              ) as HTMLInputElement;
              amount = customInputEl?.value || "5";
            }
            return amount;
          };

          // Clear container
          container.innerHTML = "";

          // Render PayPal Smart Payment Buttons
          window.paypal
            .Buttons({
              // Style the buttons
              style: {
                layout: "vertical",
                color: "gold",
                shape: "rect",
                label: "donate",
                tagline: false,
              },

              // Create order when button is clicked
              createOrder: function (data: any, actions: any) {
                const amount = getSelectedAmount();
                return actions.order.create({
                  purchase_units: [
                    {
                      description: "Aporte AFRO IN - Mill√≥n de Corazones",
                      amount: {
                        value: amount,
                        currency_code: "USD",
                      },
                    },
                  ],
                  application_context: {
                    shipping_preference: "NO_SHIPPING",
                    user_action: "PAY_NOW",
                  },
                });
              },

              // Handle approved payment
              onApprove: async function (data: any, actions: any) {
                try {
                  const order = await actions.order.capture();
                  console.log("PayPal order captured:", order);

                  const transactionId =
                    order.purchase_units[0]?.payments?.captures[0]?.id ||
                    order.id;
                  const capturedAmount =
                    order.purchase_units[0]?.payments?.captures[0]?.amount
                      ?.value || getSelectedAmount();

                  // Register donor with transaction info
                  try {
                    const response = await fetch("/api/donante", {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({
                        name: nameInput.value,
                        email: emailInput.value,
                        phone: phoneInput.value || null,
                        country: countryValue || null,
                        amount: parseFloat(capturedAmount),
                        paypal_tx: transactionId,
                        paypal_status: order.status,
                      }),
                    });
                    if (response.ok) {
                      const responseData = (await response.json()) as {
                        id: number;
                      };
                      sessionStorage.setItem(
                        "donor_id",
                        String(responseData.id)
                      );
                    }
                  } catch (error) {
                    console.error("Error registering donor:", error);
                  }

                  // Redirect to thank you page
                  showToast("¬°Gracias por tu donaci√≥n! üíõ");
                  setTimeout(() => {
                    window.location.href = `/gracias?tx=${transactionId}&amt=${capturedAmount}`;
                  }, 1000);
                } catch (error) {
                  console.error("Error capturing order:", error);
                  showToast(
                    "Error procesando el pago. Intenta de nuevo.",
                    "error"
                  );
                }
              },

              // Handle errors
              onError: function (err: any) {
                console.error("PayPal error:", err);
                showToast(
                  "Error con PayPal. Por favor intenta de nuevo.",
                  "error"
                );
              },

              // Handle cancel
              onCancel: function () {
                showToast("Pago cancelado", "error");
              },
            })
            .render("#paypal-donate-container");

          paypalButtonRendered = true;
        };

        // --- Navigation ---
        btnNext?.addEventListener("click", async () => {
          const nameInput = document.getElementById("name") as HTMLInputElement;
          const emailInput = document.getElementById(
            "email"
          ) as HTMLInputElement;
          const countryValue = tsInstance
            ? tsInstance.getValue()
            : countrySelect.value;

          if (!nameInput.value || !emailInput.value || !countryValue) {
            showToast("Por favor completa los campos obligatorios", "error");
            return;
          }
          step1?.classList.remove("active");
          step2?.classList.add("active");

          // Render PayPal button when entering step 2
          await renderPayPalButton();
        });

        btnBack?.addEventListener("click", () => {
          step2?.classList.remove("active");
          step1?.classList.add("active");
        });

        // Update PayPal button when amount changes
        const amountInputs = document.querySelectorAll('input[name="amount"]');
        amountInputs.forEach((input) => {
          input.addEventListener("change", () => {
            if (paypalButtonRendered) {
              paypalButtonRendered = false;
              renderPayPalButton();
            }
          });
        });

        const customInput = document.querySelector(
          ".custom-amount"
        ) as HTMLInputElement;
        customInput?.addEventListener("focus", () => {
          const radio = document.querySelector(
            'input[value="custom"]'
          ) as HTMLInputElement;
          if (radio) radio.checked = true;
        });

        customInput?.addEventListener("blur", () => {
          if (paypalButtonRendered) {
            paypalButtonRendered = false;
            renderPayPalButton();
          }
        });
      });
    </script>
  </div>
</section>
