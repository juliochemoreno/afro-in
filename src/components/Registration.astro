---
import { countries } from "../data/countries";
import {
  getLangFromUrl,
  useTranslations,
  getTranslatedPath,
} from "../i18n/utils";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

interface Props {
  currentCount?: number;
}

const { currentCount = 12847 } = Astro.props;
const thanksUrl = getTranslatedPath("/gracias", lang);
---

<section class="registration section" id="unirse">
  <div class="container">
    <div class="registration-wrapper">
      <div
        class="registration-content animate-fade-in-up"
        style="animation-delay: 0.1s"
      >
        <span class="section-badge">{t("join.badge")}</span>
        <h2 class="section-title">
          {t("join.title.part1")}<br /><span class="title-highlight"
            >{t("join.title.part2")}</span
          >
        </h2>

        <div class="counter-badge">
          <span class="counter-number" id="live-counter">...</span>
          <span class="counter-label">{t("join.counter")}</span>
        </div>

        <p class="registration-description" set:html={t("join.description")} />

        <ul class="benefits-list">
          <li>{t("join.benefit.1")}</li>
          <li>{t("join.benefit.2")}</li>
          <li>{t("join.benefit.3")}</li>
          <li>{t("join.benefit.4")}</li>
          <li>{t("join.benefit.5")}</li>
        </ul>
      </div>

      <div class="registration-form-wrapper">
        <div class="form-card">
          <form
            class="registration-form"
            id="registrationForm"
            data-t-country-error={t("join.country.error")}
            data-t-toast-success={t("join.toast.success")}
            data-t-toast-error={t("join.toast.error")}
            data-t-redirect-url={thanksUrl}
          >
            <!-- STEP 1: CONTACT INFO -->
            <div class="form-step active" id="step1">
              <div class="step-header">
                <span class="step-indicator">{t("join.step1")}</span>
                <h3>{t("join.form.title")}</h3>
              </div>

              <div class="form-group">
                <label for="name">{t("join.form.name")}</label>
                <input
                  type="text"
                  id="name"
                  name="name"
                  placeholder={t("join.form.name.placeholder")}
                  required
                />
              </div>

              <div class="form-group">
                <label for="email">{t("join.form.email")}</label>
                <input
                  type="email"
                  id="email"
                  name="email"
                  placeholder={t("join.form.email.placeholder")}
                  required
                />
              </div>

              <div class="form-group">
                <label for="phone">{t("join.form.phone")}</label>
                <input
                  type="tel"
                  id="phone"
                  name="phone"
                  placeholder={t("join.form.phone.placeholder")}
                />
              </div>

              <div class="form-group">
                <label for="country">{t("join.form.country")}</label>
                <select id="country" name="country" autocomplete="off">
                  <option value="">{t("join.form.country.select")}</option>
                  {
                    countries.map((c) => (
                      <option value={c.code}>
                        {c.emoji} {c.name}
                      </option>
                    ))
                  }
                </select>
              </div>

              <button
                type="button"
                class="btn btn-primary btn-block"
                id="btnNext"
              >
                {t("join.form.next")}
              </button>
            </div>

            <!-- STEP 2: DONATION -->
            <div class="form-step" id="step2">
              <div class="step-header">
                <button type="button" class="btn-back" id="btnBack"
                  >{t("join.form.back")}</button
                >
                <span class="step-indicator">{t("join.step2")}</span>
                <h3>{t("join.form.donate.title")}</h3>
              </div>

              <div class="form-donation">
                <div class="donation-options">
                  <label class="donation-option">
                    <input type="radio" name="amount" value="5" checked />
                    <span class="option-content">
                      <span class="option-amount">$5 USD</span>
                      <span class="option-desc">~20,000 COP</span>
                    </span>
                  </label>
                  <label class="donation-option">
                    <input type="radio" name="amount" value="10" />
                    <span class="option-content">
                      <span class="option-amount">$10 USD</span>
                      <span class="option-desc">~40,000 COP</span>
                    </span>
                  </label>
                  <label class="donation-option">
                    <input type="radio" name="amount" value="25" />
                    <span class="option-content">
                      <span class="option-amount">$25 USD</span>
                      <span class="option-desc">~100,000 COP</span>
                    </span>
                  </label>
                  <label class="donation-option custom">
                    <input type="radio" name="amount" value="custom" />
                    <span class="option-content">
                      <span class="option-amount"
                        >{t("join.form.donate.other")}</span
                      >
                      <input
                        type="number"
                        class="custom-amount"
                        placeholder="$"
                        min="1"
                        step="0.01"
                      />
                    </span>
                  </label>
                </div>
              </div>

              <!-- PayPal Donate Button Container -->
              <div id="paypal-donate-container"></div>

              <p class="form-note">{t("join.form.secure")}</p>
            </div>
          </form>
        </div>
      </div>
    </div>

    <style>
      .registration {
        background: var(--color-cream);
        position: relative;
        overflow: hidden;
      }

      .registration::before {
        content: "";
        position: absolute;
        top: 0;
        right: 0;
        width: 50%;
        height: 100%;
        background: var(--gradient-dark);
        border-radius: 100px 0 0 100px;
      }

      .registration-wrapper {
        position: relative;
        z-index: 1;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-xl);
        align-items: center;
      }

      /* Logo dimensions optimization */
      .section-badge {
        display: inline-block;
        padding: var(--space-xs) var(--space-md);
        background: rgba(227, 28, 37, 0.1);
        border-radius: var(--radius-full);
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--color-primary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: var(--space-md);
      }

      .section-title {
        font-size: clamp(2rem, 5vw, 3rem);
        color: var(--color-secondary);
        margin-bottom: var(--space-md);
      }

      .title-highlight {
        background: var(--gradient-gold);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .registration-description {
        font-size: 1.1rem;
        color: var(--color-text-light);
        margin-bottom: var(--space-lg);
      }

      .registration-description strong {
        color: var(--color-primary);
      }

      .benefits-list {
        list-style: none;
      }

      .benefits-list li {
        padding: var(--space-sm) 0;
        font-size: 1.05rem;
        color: var(--color-text);
      }

      .counter-badge {
        display: inline-flex;
        align-items: center;
        gap: var(--space-sm);
        background: var(--color-white);
        padding: var(--space-sm) var(--space-md);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-lg);
        box-shadow: var(--shadow-sm);
      }

      .counter-badge .counter-number {
        font-family: var(--font-heading);
        font-weight: 800;
        font-size: 1.5rem;
        color: var(--color-primary);
      }

      .counter-badge .counter-label {
        font-size: 0.9rem;
        color: var(--color-text);
        font-weight: 500;
      }

      .form-card {
        background: var(--color-white);
        border-radius: var(--radius-lg);
        padding: var(--space-lg);
        box-shadow: var(--shadow-lg);
        min-height: 400px;
        display: flex;
        align-items: center;
      }

      .registration-form {
        width: 100%;
      }

      .form-step {
        display: none;
        animation: fadeIn 0.3s ease-in-out;
      }

      .form-step.active {
        display: block;
      }

      .step-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--space-lg);
        border-bottom: 1px solid var(--color-cream-dark);
        padding-bottom: var(--space-sm);
      }

      .step-indicator {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--color-text-light);
      }

      .step-header h3 {
        font-size: 1.2rem;
        color: var(--color-secondary);
        margin: 0;
      }

      .form-group {
        margin-bottom: var(--space-md);
      }

      .btn-block {
        width: 100%;
        margin-top: var(--space-md);
      }

      .btn-back {
        background: none;
        border: none;
        color: var(--color-text-light);
        font-size: 0.9rem;
        cursor: pointer;
        padding: 0;
        text-decoration: underline;
      }

      .btn-back:hover {
        color: var(--color-primary);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .form-group label {
        display: block;
        font-weight: 500;
        margin-bottom: var(--space-xs);
        color: var(--color-text);
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: var(--space-sm) var(--space-md);
        border: 1px solid var(--color-cream-dark);
        border-radius: var(--radius-md);
        font-family: inherit;
        font-size: 1rem;
        transition: all var(--transition-fast);
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgba(227, 28, 37, 0.1);
      }

      .form-donation {
        margin: var(--space-lg) 0;
      }

      .donation-options {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--space-sm);
      }

      .donation-option input[type="radio"] {
        display: none;
      }

      .option-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: var(--space-md);
        border: 2px solid var(--color-cream-dark);
        border-radius: var(--radius-md);
        transition: all var(--transition-fast);
        height: 100%;
        min-height: 100px;
      }

      .donation-option input:checked + .option-content {
        border-color: var(--color-primary);
        background: rgba(227, 28, 37, 0.05);
      }

      .option-amount {
        font-family: var(--font-heading);
        font-weight: 700;
        font-size: 1.2rem;
        color: var(--color-secondary);
      }

      .option-desc {
        font-size: 0.8rem;
        color: var(--color-text-light);
      }

      .custom-amount {
        width: 80px;
        margin-top: var(--space-xs);
        padding: var(--space-xs);
        border: 1px solid var(--color-cream-dark);
        border-radius: var(--radius-sm);
        text-align: center;
      }

      #paypal-donate-container {
        width: 100%;
        min-height: 50px;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: var(--space-md);
        margin-bottom: var(--space-sm);
      }

      #paypal-donate-container img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
        transition:
          transform var(--transition-fast),
          opacity var(--transition-fast);
      }

      #paypal-donate-container img:hover {
        transform: scale(1.02);
        opacity: 0.9;
      }

      .form-note {
        text-align: center;
        font-size: 0.85rem;
        color: var(--color-text-light);
        margin-top: var(--space-md);
      }

      @media (max-width: 968px) {
        .registration::before {
          display: none;
        }
        .registration-wrapper {
          grid-template-columns: 1fr;
        }
        .registration-content {
          text-align: center;
        }
        .benefits-list {
          display: inline-block;
          text-align: left;
        }
      }

      @media (max-width: 600px) {
        .form-card {
          padding: var(--space-lg) var(--space-md);
        }
        .donation-options {
          grid-template-columns: 1fr;
        }
      }
    </style>

    <style is:global>
      /* Tom Select Custom Styling - Loaded in head but needs global styles here */
      .ts-wrapper.single .ts-control {
        padding: 0.8rem 1rem !important;
        border: 1px solid var(--color-cream-dark) !important;
        border-radius: var(--radius-md) !important;
        font-family: var(--font-body) !important;
        font-size: 1rem !important;
        background: var(--color-white) !important;
        box-shadow: none !important;
        min-height: 44px;
        display: flex;
        align-items: center;
      }
      .ts-wrapper.single.focus .ts-control {
        border-color: var(--color-primary) !important;
        box-shadow: 0 0 0 3px rgba(227, 28, 37, 0.1) !important;
      }
      .ts-dropdown {
        border-radius: var(--radius-md) !important;
        border: 1px solid var(--color-cream-dark) !important;
        box-shadow: var(--shadow-lg) !important;
        margin-top: 5px !important;
        z-index: 1000 !important;
      }
      .ts-dropdown .option.active {
        background-color: rgba(227, 28, 37, 0.1) !important;
        color: var(--color-primary) !important;
      }
    </style>

    <script>
      import { showToast } from "../lib/cart";

      declare global {
        interface Window {
          TomSelect: any;
          PayPal: any;
        }
      }

      document.addEventListener("astro:page-load", () => {
        // --- Live Counter ---
        const liveCounter = document.getElementById("live-counter");
        async function updateCounter() {
          if (!liveCounter) return;
          try {
            const response = await fetch("/api/contador");
            if (response.ok) {
              const data = (await response.json()) as { total: number };
              liveCounter.textContent = data.total.toLocaleString();
            }
          } catch (error) {}
        }
        updateCounter();
        setInterval(updateCounter, 30000);

        // --- Form Controls ---
        const form = document.getElementById(
          "registrationForm"
        ) as HTMLFormElement;
        const step1 = document.getElementById("step1");
        const step2 = document.getElementById("step2");
        const btnNext = document.getElementById("btnNext");
        const btnBack = document.getElementById("btnBack");
        const countrySelect = document.getElementById(
          "country"
        ) as any as HTMLSelectElement;
        let tsInstance: any = null;
        let paypalButtonRendered = false;

        // --- Lazy TomSelect ---
        const loadTomSelect = async () => {
          if (window.TomSelect || tsInstance) return;

          // Load CSS and JS dynamically
          if (!document.getElementById("tom-select-css")) {
            const link = document.createElement("link");
            link.id = "tom-select-css";
            link.rel = "stylesheet";
            link.href =
              "https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css";
            document.head.appendChild(link);
          }

          if (!window.TomSelect) {
            await new Promise((resolve) => {
              const script = document.createElement("script");
              script.src =
                "https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js";
              script.onload = resolve;
              document.body.appendChild(script);
            });
          }

          if (countrySelect && window.TomSelect && !tsInstance) {
            tsInstance = new window.TomSelect(countrySelect, {
              create: false,
              sortField: { field: "text", direction: "asc" },
              render: {
                no_results: () =>
                  `<div class="no-results">${form.dataset.tCountryError}</div>`,
              },
            });
            tsInstance.setValue("CO");
            fetch("https://ipapi.co/json/")
              .then((r) => r.json())
              .then((d: any) => {
                if (d.country_code && tsInstance)
                  tsInstance.setValue(d.country_code);
              })
              .catch(() => {});
          }
        };

        const initLazy = () => {
          loadTomSelect();
          countrySelect?.removeEventListener("focus", initLazy);
        };
        countrySelect?.addEventListener("focus", initLazy);

        const observer = new IntersectionObserver(
          (entries) => {
            if (entries[0].isIntersecting) {
              loadTomSelect();
              observer.disconnect();
            }
          },
          { rootMargin: "200px" }
        );
        const section = document.getElementById("unirse");
        if (section) observer.observe(section);

        // --- Load PayPal Donate SDK ---
        const loadPayPalSDK = async (): Promise<void> => {
          if (window.PayPal) return;

          return new Promise((resolve) => {
            const script = document.createElement("script");
            script.src =
              "https://www.paypalobjects.com/donate/sdk/donate-sdk.js";
            script.charset = "UTF-8";
            script.onload = () => resolve();
            document.body.appendChild(script);
          });
        };

        // --- Render PayPal Button ---
        const renderPayPalButton = async () => {
          if (paypalButtonRendered) return;

          await loadPayPalSDK();

          const container = document.getElementById("paypal-donate-container");
          if (!container || !window.PayPal) return;

          // Get form data
          const nameInput = document.getElementById("name") as HTMLInputElement;
          const emailInput = document.getElementById(
            "email"
          ) as HTMLInputElement;
          const phoneInput = document.getElementById(
            "phone"
          ) as HTMLInputElement;
          const countryValue = tsInstance
            ? tsInstance.getValue()
            : countrySelect.value;

          // Get selected amount
          const selectedAmountEl = form.querySelector(
            'input[name="amount"]:checked'
          ) as HTMLInputElement;
          let amount = selectedAmountEl?.value || "5";

          if (amount === "custom") {
            const customInputEl = document.querySelector(
              ".custom-amount"
            ) as HTMLInputElement;
            amount = customInputEl?.value || "5";
          }

          // Clear container and render button
          container.innerHTML = "";

          window.PayPal.Donation.Button({
            env: "production",
            // Use business email instead of hosted_button_id for dynamic amount control
            business: "afroinsantamarta@gmail.com",
            // Pre-fill amount from form selection
            amount: amount,
            currency_code: "USD",
            item_name: "Aporte AFRO IN - MillÃ³n de Corazones",
            image: {
              src: "https://www.paypalobjects.com/es_ES/ES/i/btn/btn_donateCC_LG.gif",
              title: "PayPal - Donar de forma segura",
              alt: "Donar con PayPal",
            },
            onComplete: async function (params: {
              tx: string;
              st: string;
              amt: string;
              cc: string;
              cm: string;
              item_number: string;
              item_name: string;
            }) {
              console.log("PayPal donation completed:", params);

              // Register donor with transaction info
              try {
                const response = await fetch("/api/donante", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    name: nameInput.value,
                    email: emailInput.value,
                    phone: phoneInput.value || null,
                    country: countryValue || null,
                    amount: parseFloat(params.amt || amount),
                    paypal_tx: params.tx,
                    paypal_status: params.st,
                  }),
                });
                if (response.ok) {
                  const data = (await response.json()) as { id: number };
                  sessionStorage.setItem("donor_id", String(data.id));
                }
              } catch (error) {
                console.error("Error registering donor:", error);
              }

              // Redirect to thank you page
              showToast(form.dataset.tToastSuccess || "");
              setTimeout(() => {
                const redirectBase = form.dataset.tRedirectUrl || "/gracias";
                window.location.href = `${redirectBase}?tx=${params.tx}&amt=${params.amt}`;
              }, 1000);
            },
          }).render("#paypal-donate-container");

          paypalButtonRendered = true;
        };

        // --- Navigation ---
        btnNext?.addEventListener("click", async () => {
          const nameInput = document.getElementById("name") as HTMLInputElement;
          const emailInput = document.getElementById(
            "email"
          ) as HTMLInputElement;
          const countryValue = tsInstance
            ? tsInstance.getValue()
            : countrySelect.value;

          if (!nameInput.value || !emailInput.value || !countryValue) {
            showToast(form.dataset.tToastError || "", "error");
            return;
          }
          step1?.classList.remove("active");
          step2?.classList.add("active");

          // Render PayPal button when entering step 2
          await renderPayPalButton();
        });

        btnBack?.addEventListener("click", () => {
          step2?.classList.remove("active");
          step1?.classList.add("active");
        });

        // Update PayPal button when amount changes
        const amountInputs = document.querySelectorAll('input[name="amount"]');
        amountInputs.forEach((input) => {
          input.addEventListener("change", () => {
            if (paypalButtonRendered) {
              paypalButtonRendered = false;
              renderPayPalButton();
            }
          });
        });

        const customInput = document.querySelector(
          ".custom-amount"
        ) as HTMLInputElement;
        customInput?.addEventListener("focus", () => {
          const radio = document.querySelector(
            'input[value="custom"]'
          ) as HTMLInputElement;
          if (radio) radio.checked = true;
        });

        customInput?.addEventListener("blur", () => {
          if (paypalButtonRendered) {
            paypalButtonRendered = false;
            renderPayPalButton();
          }
        });
      });
    </script>
  </div>
</section>
